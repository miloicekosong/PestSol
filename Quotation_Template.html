<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/css/bootstrap-datepicker.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --primary-color: #F9A610;
    }

    body {
      background-color: lightgray;
      margin-top: 2%;
      margin-bottom: 2%;
      min-height: 1000px;
      margin-left: auto;
      margin-right: auto;
    }

    img {
      max-width: 100%;
      height: auto;
    }

    .main-container {
      padding: 3%;
      width: 100%;
      min-height: 1000px;
      background-color: white;
      box-shadow: 1px 1px 7px 2px rgba(122, 109, 109, 0.75);
      -webkit-box-shadow: 1px 1px 7px 2px rgba(122, 109, 109, 0.75);
      -moz-box-shadow: 1px 1px 7px 2px rgba(122, 109, 109, 0.75);
      display: block;
    }

    .company-logo-container {
      display: grid;
    }

    .company-logo {
      justify-self: flex-end;
    }

    .no-margin {
      margin: 0 !important;
    }

    .no-padding {
      padding: 0 !important;
    }

    /* Base styles (Mobile first) */
    .font-m {
      font-family: 'Trebuchet MS', sans-serif;
      font-size: 16px;
    }

    .font-s {
      font-family: 'Trebuchet MS', sans-serif;
      font-size: 14px;
    }

    .font-xs {
      font-family: 'Trebuchet MS', sans-serif;
      font-size: 12px;
    }

    .font-xxs {
      font-family: 'Trebuchet MS', sans-serif;
      font-size: 10px;
    }

    /* Tablet styles */
    @media screen and (min-width: 768px) and (max-width: 1023px) {
      .font-m {
        font-size: 18px;
      }

      .font-s {
        font-size: 16px;
      }

      .font-xs {
        font-size: 14px;
      }

      .font-xxs {
        font-size: 12px;
      }
    }

    /* PC styles */
    @media screen and (min-width: 1024px) {
      .font-m {
        font-size: 20px;
      }

      .font-s {
        font-size: 18px;
      }

      .font-xs {
        font-size: 16px;
      }

      .font-xxs {
        font-size: 14px;
      }
    }

    .font-bold {
      font-weight: bold;
    }

    .color-primary {
      color: var(--primary-color) !important;
    }


    .signature-pad--body {
      position: relative;
      -webkit-box-flex: 1;
      -ms-flex: 1;
      flex: 1;
      border: 1px solid #d9d9d9;
      height: 150px;
    }

    .signature-pad--body canvas {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
    }

    .datepicker {
      border-radius: 0 !important;
    }

    .loader-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      /* Semi-transparent background */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      /* Ensure it covers all other elements */
    }

    .circle {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: var(--primary-color);
      left: 15%;
      transform-origin: 50%;
      margin-left: 10px;
      animation: circle7124 .5s alternate infinite ease;
    }

    @keyframes circle7124 {
      0% {
        top: 60px;
        height: 5px;
        border-radius: 50px 50px 25px 25px;
        transform: scaleX(1.7);
      }

      40% {
        height: 20px;
        border-radius: 50%;
        transform: scaleX(1);
      }

      100% {
        top: 0%;
      }
    }

    .circle:nth-child(2) {
      left: 45%;
      animation-delay: .2s;
    }

    .circle:nth-child(3) {
      left: auto;
      right: 15%;
      animation-delay: .3s;
    }

    .card {
      width: 330px;
      height: 80px;
      border-radius: 8px;
      box-sizing: border-box;
      padding: 10px 15px;
      background-color: #ffffff;
      box-shadow: rgba(149, 157, 165, 0.2) 0px 8px 24px;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: space-around;
      gap: 15px;
    }

    .wave {
      position: absolute;
      transform: rotate(90deg);
      left: -31px;
      top: 32px;
      width: 80px;
      fill: var(--primary-color);
    }

    .icon-container {
      width: 35px;
      height: 35px;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: var(--primary-color);
      border-radius: 50%;
      margin-left: 8px;
    }

    .icon {
      width: 17px;
      height: 17px;
      color: #269b24;
    }

    .message-text-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      flex-grow: 1;
    }

    .message-text,
    .sub-text {
      margin: 0;
      cursor: default;
    }

    .message-text {
      color: var(--primary-color);
      font-size: 17px;
      font-weight: 700;
    }

    .sub-text {
      font-size: 14px;
      color: #555;
    }

    .cross-icon {
      width: 18px;
      height: 18px;
      color: #555;
      cursor: pointer;
    }

    .no-page-break {
      page-break-inside: avoid;
    }

    .page-break {
      page-break-before: always;
    }

    @media print {
      .page-break {
        page-break-before: always;
      }

      .no-page-break {
        page-break-inside: avoid;
      }
    }

    @media (max-width: 768px) {
      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    table {
      border-collapse: collapse !important;
    }

    table td,
    table th {
      border: 1px solid #dee2e6 !important;
      padding: 0.5rem !important;
    }
  </style>
</head>

<body>
  <div id="loader" class="loader-wrapper" style="width: 100%; display: none;">
    <div class="circle"></div>
    <div class="circle"></div>
    <div class="circle"></div>
    <div id="success-card" class="card" style="display: none;">
      <svg class="wave" viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M0,256L11.4,240C22.9,224,46,192,69,192C91.4,192,114,224,137,234.7C160,245,183,235,206,213.3C228.6,192,251,160,274,149.3C297.1,139,320,149,343,181.3C365.7,213,389,267,411,282.7C434.3,299,457,277,480,250.7C502.9,224,526,192,549,181.3C571.4,171,594,181,617,208C640,235,663,277,686,256C708.6,235,731,149,754,122.7C777.1,96,800,128,823,165.3C845.7,203,869,245,891,224C914.3,203,937,117,960,112C982.9,107,1006,181,1029,197.3C1051.4,213,1074,171,1097,144C1120,117,1143,107,1166,133.3C1188.6,160,1211,224,1234,218.7C1257.1,213,1280,139,1303,133.3C1325.7,128,1349,192,1371,192C1394.3,192,1417,128,1429,96L1440,64L1440,320L1428.6,320C1417.1,320,1394,320,1371,320C1348.6,320,1326,320,1303,320C1280,320,1257,320,1234,320C1211.4,320,1189,320,1166,320C1142.9,320,1120,320,1097,320C1074.3,320,1051,320,1029,320C1005.7,320,983,320,960,320C937.1,320,914,320,891,320C868.6,320,846,320,823,320C800,320,777,320,754,320C731.4,320,709,320,686,320C662.9,320,640,320,617,320C594.3,320,571,320,549,320C525.7,320,503,320,480,320C457.1,320,434,320,411,320C388.6,320,366,320,343,320C320,320,297,320,274,320C251.4,320,229,320,206,320C182.9,320,160,320,137,320C114.3,320,91,320,69,320C45.7,320,23,320,11,320L0,320Z"
          fill-opacity="1"></path>
      </svg>

      <div class="icon-container">

      </div>
      <div class="message-text-container">
        <p class="message-text"></p>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 15" stroke-width="0" fill="none" stroke="currentColor"
        class="cross-icon">
        <path fill="currentColor"
          d="M11.7816 4.03157C12.0062 3.80702 12.0062 3.44295 11.7816 3.2184C11.5571 2.99385 11.193 2.99385 10.9685 3.2184L7.50005 6.68682L4.03164 3.2184C3.80708 2.99385 3.44301 2.99385 3.21846 3.2184C2.99391 3.44295 2.99391 3.80702 3.21846 4.03157L6.68688 7.49999L3.21846 10.9684C2.99391 11.193 2.99391 11.557 3.21846 11.7816C3.44301 12.0061 3.80708 12.0061 4.03164 11.7816L7.50005 8.31316L10.9685 11.7816C11.193 12.0061 11.5571 12.0061 11.7816 11.7816C12.0062 11.557 12.0062 11.193 11.7816 10.9684L8.31322 7.49999L11.7816 4.03157Z"
          clip-rule="evenodd" fill-rule="evenodd"></path>
      </svg>
    </div>

  </div>
  <div class="modal fade" id="confirmation-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <h3 id="confirmation-message">
            </h2>

        </div>
        <div class="modal-footer">
          <button id="btnConfirmModal" type="button" class="btn btn-success">Confirm</button>
        </div>
      </div>
    </div>
  </div>
  <div class="mb-2 d-flex justify-content-end">
    <button id="btnSubmit" class="btn btn-primary btn-sm font-m">Submit</button>
    <button id="btnSendEmail" class="btn btn-success btn-sm font-m" style="margin-left:10px"> Send to Customer for
      e-signature</button>
    <button id="btnDownloadPdf" class="btn btn-primary btn-sm font-m"
      style="margin-left:10px;display:none">Download</button>
  </div>
  <div class="main-container col col-12 row no-margin">
    <div class="col col-12 row no-margin">
      <div class="company-info col-8">
        <label class="font-xxs font-bold">PestSol Sdn Bhd <br> (202301006003 (1499922-V))</label><br>
        <label class="font-xxs">No. 34-1, Jalan PUJ 3/8, Taman Puncak,<br> Jalil,
          Bandar Putra Permai,<br> 43300
          Seri Kembangan, Selangor,<br> +6011-6173 1032<br> pestsol178@gmail.com</label>
      </div>
      <div class="company-logo-container col-4">
        <img id="company-logo" class="company-logo" src="">
      </div>
    </div>
    <div class="col col-12 row no-margin">
      <div class="col col-12 text-end no-margin">
        <div class="text-end">
          <span class="font-bold font-xs">QUOTATION</span>
          <span id="docNumber" class="font-bold font-xs"></span>
        </div>
        <div class="text-end">
          <span class="font-bold font-xs">DATE</span>
          <span id="docDate" class="font-bold font-xs"></span>
        </div>
      </div>
    </div>

    <div class="row no-margin table-responsive col-12 pt-3">
      <div class="col-12">
        <table class="table font-xxs no-margin">
          <thead>
            <tr>
              <th style="background:#F9A610; color:white; width: 50%;" colspan="2" class="text-start font-bold">PERSON
                IN CHARGE INFO</td>
              <th style="background:#F9A610; color:white; width: 50%;" colspan="2" class="text-start font-bold">COMPANY
                INFO</td>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="width: 10%;" class="text-start font-bold">Name</td>
              <td style="width: 40%;" class="text-start"><label id="picName" class="font-xxs"></label></td>
              <td style="width: 10%;" class="text-start font-bold">Name</td>
              <td style="width: 40%;" class="text-start"><label id="companyName" class="font-xxs"></label>
              </td>
            </tr>
            <tr>
              <td style="width: 10%;" class="text-start font-bold">Email</td>
              <td style="width: 40%;" class="text-start"><label id="picEmail" class="font-xxs"></label></td>
              <td style="width: 10%;" class="text-start font-bold">Email</td>
              <td style="width: 40%;" class="text-start"><label id="companyEmail" class="font-xxs"></label>
              </td>
            </tr>
            <tr>
              <td style="width: 10%;" class="text-start font-bold">Contact</td>
              <td style="width: 40%;" class="text-start"><label id="picContact" class="font-xxs"></label></td>
              <td style="width: 10%;" class="text-start font-bold">Contact</td>
              <td style="width: 40%;" class="text-start"><label id="companyContact" class="font-xxs"></label>
              </td>
            </tr>
            <tr>
              <td colspan="4">
                <label class="font-bold font-xxs">Service Address : </label><br>
                <label class="font-xxs" id="billingAddress"></label>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <input type="hidden" id="recordId" />
    <div class="row no-margin col-12 table-responsive pt-3">
      <div class="container mt-5">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th style="background:#F9A610; color:white; width: 50%" class="text-start font-xxs font-bold">SERVICE</th>
              <th style="background:#F9A610; color:white; width: 10%" class="text-end font-xxs font-bold">QTY</th>
              <th style="background:#F9A610; color:white;" class="text-end font-xxs font-bold">RATE</th>
              <th style="background:#F9A610; color:white;" class="text-end font-xxs font-bold">AMOUNT</th>
              <th style="background:#F9A610; color:white;"
                class="background:#F9A610; color:white; text-center actionRow align-content-center">
                <button id="addRowBtn" class="btn btn-primary btn-sm font-xxs"><i class="fas fa-plus"></i></button>
              </th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr class="itemRow">
              <td>
                <select class="form-control font-xxs ddlItem" style="width: max-content;"></select>
                <label contenteditable="true" class="font-xxs mt-2 inputDescription"
                  style="white-space: pre-line"></label>
              </td>
              <td contenteditable="true"
                class="text-center font-xxs align-items-center justify-content-center quantityInput"></td>
              <td contenteditable="true" class="text-end font-xxs align-items-center rateInput"></td>
              <td class="text-end font-xxs align-items-center amountInput"></td>
              <td class="text-center actionRow"><button class="btn btn-danger btn-sm deleteRowBtn font-xxs"><i
                    class="fas fa-times"></i></button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row no-margin col-12 no-page-break pt-3">
      <div class="col-12 col-md-12">
        <div class="col-12 col-md-12 d-flex justify-content-end mb-2">
          <label class="font-xs font-bold text-end col-7 align-content-center">SUBTOTAL (RM)</label>
          <input id="inputSubtotal" type="text" class="form-control font-xs font-bold text-end" value="0"
            readonly="true" style="margin-left: 10px;" />
        </div>
        <div id="discountOptionContainer" class="col-12 col-md-12 d-flex justify-content-end mb-2">
          <select id="inputDiscountOption" class="font-bold font-xs text-end col-7" style="border:none !important">
            <option value="0">-- SELECT DISCOUNT --</option>
            <option value="1">DISCOUNT PERCENT</option>
            <option value="2">DISCOUNT VALUE</option>
          </select>
          <input id="inputDiscount" disabled="true" contenteditable="true" type="text"
            class="form-control font-xs font-bold text-end" value="0" style="margin-left: 10px;" />
        </div>
        <div class="col-12 col-md-12 d-flex justify-content-end mb-2">
          <label class="font-xs font-bold text-end col-7">TOTAL AMOUNT (RM)</label>
          <input id="inputTotalAmount" type="text" class="form-control font-xs font-bold text-end" value="0"
            readonly="true" style="margin-left: 10px;" />
        </div>
      </div>
    </div>

    <div class="row no-margin col-12 no-page-break pt-3">
      <div class="col-12 col-md-6 order-2 order-md-1">
        <label class="font-xxs col-12">- All cheque must be crossed and made payable to<br>
          - PESTSOL SDN BHD (Ambank Current Account: 8881054200790)<br>
          - Kindly key in the invoice number in the reference, example: QUO0001<br>
          - Kindly send the receipt or transaction record to<br>
          - <a href="pestsol178@gmail.com">pestsol178@gmail.com</a> or +6011-6173 1032<br>
          - For credit card, above RM 1,000 only.</label>
        <img id="bankinNote" class="col-12 no-page-break" src="" style="width: 150px !important;"">
      </div>
      <div class=" col-12 col-md-6 order-1 order-md-2">
        <div class="col-12 col-md-12 d-flex justify-content-between mb-2">
          <button id="btnClearSignature" class="btn btn-secondary btn-sm font-xxs col-3">Clear</button>
          <button id="btnStartSigning" class="btn btn-primary btn-sm font-xxs col-3">Start Signing</button>
          <button id="btnComputerSignature" class="btn btn-success btn-sm font-xxs col-3"
            style="margin-right: 3px;">Computer Sign</button>
        </div>
        <div class="col-12">
          <table class="table table-bordered">
            <tbody>
              <tr>
                <td style="width: 50%" class="font-xxs"><label>Accepted By</label> </td>
              </tr>
              <tr>
                <td id="signatureCell" style="height:180px;text-align: center;">
                  <div id="signature-pad" class="signature-pad no-padding">
                    <div class="signature-pad--body"> <canvas></canvas> </div>
                  </div>
                  <label id="computerSignLabel" class="text-center font-xs" style="display: none;">This is a
                    computer-generated
                    document. No signature is required.</label>
                </td>
              </tr>
              <tr>
                <td id="signBy" contenteditable="true" style="width: 50%" class="font-xxs"></td>
              </tr>
              <tr>
                <td>
                  <input type="date" id="signedDate" class="form-control datepicker" data-date-format="DD MMMM YYYY"
                    value="2015-08-09">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <script id="init-script">
    $(document).ready(function () {
      var picName = getUrlParameter('picName');
      var picContact = getUrlParameter('picContact');
      var picEmail = getUrlParameter('picEmail');
      var companyLogoLink = "https://raw.githubusercontent.com/miloicekosong/pestsol/main/logo.png";
      var bankinNoteLink = "https://raw.githubusercontent.com/miloicekosong/pestsol/main/qr-bank.png";

      var companyName = getUrlParameter('companyName');
      var companyContact = getUrlParameter('companyContact');
      var companyEmail = getUrlParameter('companyEmail');
      var billingEmail = getUrlParameter('billingEmail');
      var billingBuilding = getUrlParameter('billingBuilding');
      var billingUnit = getUrlParameter('billingUnit');
      var billingAddr1 = getUrlParameter('billingAddr1');
      var billingAddr2 = getUrlParameter('billingAddr2');
      var billingPostalCode = getUrlParameter('billingPostalCode');
      var billingCity = getUrlParameter('billingCity');
      var billingState = getUrlParameter('billingState');
      var warrantyStartDate = moment().format('DD/MM/YYYY');
      var warrantyEndDate = moment().add(3, 'years').format('DD/MM/YYYY');

      var docNumber = getUrlParameter('docNumber');
      var recordId = getUrlParameter('recordId');
      var docDate = moment(parseInt(getUrlParameter('date'))).format('DD-MM-YYYY');

      var termiteDescription = `Service Include:<br>1. AG (Above Ground) Baiting System, cover area under premise<br>2.
    Fortnightly visitation to change/check baiting until termite eliminate<br>3. Fortnightly visitation will be continue
    if termite infestation again within the warranty period<br>4. E - Certificate for recognize of Termite Control
    Service<br>Warranty Period:${warrantyStartDate} - ${warrantyEndDate}<br>Target Pest:<br>Termite`;
      var correctiveSoilDescription = `Service Include:<br>1. Drilling along the premises perimeter, 2 feet distance
    within the hole, 2 feet depth into soil<br>2. Termite chemical injection into soi<br>3. Termite baiting will be
    apply if termite infestation within warranty<br>4. E - Certificate for recognize of Termite Control
    Service<br>Warranty Period:<br>${warrantyStartDate} - ${warrantyEndDate}<br>Target Pest:<br>Termite`;
      var termiteSpray = `Service Include:<br>1. Chemical spray along the premises perimeter<br>Target Pest:<br>Termite`;
      var generalPestControlDescription = `Service Include:<br>1. Chemical spray along the premises perimeter<br>2.
    Cockroach Baiting<br>3. Rodent Baiting<br>4. Rodent Glue Board<br>5. Ant Baiting<br>Warranty Period:
    ${warrantyStartDate} - ${warrantyEndDate}<br>Target Pest:<br>Cockroach<br>Ant<br>Rodent<br>Other Crawling Bugs`;
      var bedBugsDescription = `Service Include:<br>1. Chemical misting along the premises perimeter<br>2. 3 Services
    every 3 days<br>Target Pest:<br>Bedbugs`;
      var generalPestControlMistingDescription = `Service Include:<br>1. Chemical spray and misting along the premises
    perimeter<br>2. Cockroach Baiting<br>3. Rodent Baiting<br>4. Rodent Glue Board<br>5. Ant Baiting<br>Warranty Period:
    ${warrantyStartDate} - ${warrantyEndDate}<br>Target
    Pest:<br>Bedbugs<br>Cockroach<br>Ant<br>Rodent<br>Spider<br>Flies<br>Mosquito<br>Other Flying Bugs<br>Other Crawling
    Bugs`;
      var mistingDescription = `Service Include:<br>1. Chemical misting along the premises perimeter<br>2. Cockroach
    Baiting<br>3. Rodent Baiting<br>4. Rodent Glue Board<br>5. Ant Baiting<br>Warranty Period: ${warrantyStartDate} -
    ${warrantyEndDate}<br>Target Pest:<br>Bedbugs<br>Cockroach<br>Ant<br>Rodent<br>Spider<br>Flies<br>Mosquito<br>Other
    flying bugs"`;

      var items = `<option value="P001" rate="" description="">Insert Trap - Decor 30</option>
    <option value="P002" rate="80" description="">Glue Board - 10 PCS</option>
    <option value="P003" rate="50" description="">Insert Trap Rent</option>
    <option value="P003" rate="45" description="">TRBS</option>
    <option value="P004" rate="700" description="">Fly Trap</option>
    <option value="P005" rate="1200" description="">Fly Trap (General Pest Control - 1Y12J)</option>
    <option value="P006" rate="50" description="">Light Bulb</option>
    <option value="P007" rate="80" description="">Gel Bait - Ant</option>
    <option value="P009" rate="80" description="">Gel Bait - Cockroach</option>
    <option value="P010" rate="" description="">Kleen Up - 5 Litre</option>
    <option value="P011" rate="" description="">Keen Up - 25 Litre</option>
    <option value="P012" rate="" description="">Keen Up Plus - 5 Litre</option>
    <option value="P013" rate="" description="">Keen Up Plus - 25 Litre</option>
    <option value="S00017" rate="1500" description='${termiteDescription}'>[contract] Termite Baiting - 2Y</option>
    <option value="S00001" rate="1800" description='${termiteDescription}'>[contract] Termite Baiting - 3Y</option>
    <option value="S00002" rate="3000" description='${termiteDescription}'>[contract] Termite Baiting - 5Y</option>
    <option value="S00003" rate="2500" description='${correctiveSoilDescription}'>[contract] Corrective Soil Treatment -
      5Y</option>
    <option value="S00004" rate="600" description='${termiteSpray}'>Termite Spray</option>
    <option value="S00005" rate="700" description='${bedBugsDescription}'>Bedbugs</option>
    <option value="S00006" rate="1800" description='${generalPestControlDescription}'>[contract] General Pest Control -
      1Y12J</option>
    <option value="S00007" rate="1020" description='${generalPestControlDescription}'>[contract] General Pest Control -
      1Y6J</option>
    <option value="S00008" rate="760" description='${generalPestControlDescription}'>[contract] General Pest Control -
      1Y4J</option>
    <option value="S00009" rate="630" description='${generalPestControlDescription}'>[contract] General Pest Control -
      1Y3J</option>
    <option value="S00010" rate="250" description='${generalPestControlDescription}'>General Pest Control</option>
    <option value="S00011" rate="3000" description='${generalPestControlMistingDescription}'>[contract] General Pest
      Control & Misting - 1Y12J</option>
    <option value="S00012" rate="1740" description='${generalPestControlMistingDescription}'>[contract] General Pest
      Control & Misting - 1Y6J</option>
    <option value="S00013" rate="1320" description='${generalPestControlMistingDescription}'>[contract] General Pest
      Control & Misting - 1Y4J</option>
    <option value="S00014" rate="1110" description='${generalPestControlMistingDescription}'>[contract] General Pest
      Control & Misting - 1Y3J</option>
    <option value="S00015" rate="400" description='${generalPestControlMistingDescription}'>General Pest Control &
      Misting</option>
    <option value="S00016" rate="300" description=''>Misting</option>
    <option value="S00018" rate="240" description="">Larvicide 1M 3 J</option>
    <option value="S00019" rate="750" description="">Mosquito Misting 1M 3J</option>
    <option value="" rate="" description="">Hours</option>
    <option value="" rate="" description="">History</option>`;

      var inputSubtotal = $("#inputSubtotal");
      var inputDiscount = $("#inputDiscount");
      var inputDiscountOption = $("#inputDiscountOption");
      var inputTotalAmount = $("#inputTotalAmount");

      $("#picName").text(picName);
      $("#picContact").text(picContact);
      $("#picEmail").text(picEmail);

      $("#companyName").text(companyName);
      $("#companyContact").text(companyContact);
      $("#companyEmail").text(companyEmail);
      $("#billingBuilding").text(billingBuilding);
      $("#billingAddr1").text(`${billingUnit}, ${billingAddr1},`);
      $("#billingAddr2").text(`${billingAddr2},`);
      $("#billingAddr3").text(`${billingPostalCode}, ${billingCity}, ${billingState}`);

      $("#docNumber").text(docNumber);
      $("#docDate").text(docDate);
      $("#recordId").val(recordId);
      $("#company-logo").attr("src", companyLogoLink);
      $("#bankinNote").attr("src", bankinNoteLink);

      formatAddress(billingBuilding, billingUnit, billingAddr1, billingAddr2, billingPostalCode, billingCity,
        billingState);

      $("img").each(async function () {
        var imageLink = $(this).attr('src');
        if (imageLink.startsWith('http')) {
          var base64 = await imageToBase64(imageLink);
          $(this).attr('src', base64);
        }
      });

      $(".ddlItem").append(items);

      $('.main-container').on('focus', '[contenteditable="true"]:not(.inputDescription)', function () {
        var originalText = $(this).text().trim();
        var originalValue = $(this).val().trim();
        $(this).attr('data-original-text', originalText);
        $(this).attr('data-original-value', originalValue);
        $(this).text('');
        $(this).val('');
      }).on('blur', '[contenteditable="true"]', function () {
        if ($(this).text().trim() === '') {
          $(this).text($(this).attr('data-original-text'));
        }
        if ($(this).val().trim() === '') {
          $(this).val($(this).attr('data-original-value'));
        }
      });

      $('#inputDiscount[contenteditable="true"]').on('blur', function () {
        calculateTotalAmount();
      });
      $('#inputDiscountOption').on('change', function () {
        if ($(this).val() !== "0") {
          $("#inputDiscount").attr("disabled", false);
        }
        else {
          $("#inputDiscount").attr("disabled", true);
        }
        calculateTotalAmount();
      });

      $('#addRowBtn').click(function () {
        var newRow =
          `
    <tr class='itemRow'>
      <td>
        <select class="form-control font-xs ddlItem" style="width: max-content;">
          ${items}
        </select>
        <label contenteditable="true" class="font-xxs mt-2 inputDescription" style="white-space: pre-line"></label>
      </td>
      <td contenteditable="true" class="text-center font-xxs align-items-center justify-content-center quantityInput">
      </td>
      <td contenteditable="true" class="text-end font-xxs align-items-center rateInput"></td>
      <td class="text-end font-xxs align-items-center amountInput"></td>
      <td class="text-center actionRow"><button class="btn btn-danger btn-sm deleteRowBtn font-xxs"><i
            class="fas fa-times"></i></button></td>
    </tr>
    `;
        $('#tableBody').append(newRow);
        rebindItemRowEvents();
      });

      $('#tableBody').on('click', '.deleteRowBtn', function () {
        $(this).closest('tr').remove();
        calculateTotalAmount();
      });

      rebindItemRowEvents();
      function rebindItemRowEvents() {
        $('.itemRow .ddlItem').unbind().on('change', function () {
          calculateRow($(this).parent());
        });
        $('.itemRow .quantityInput').unbind().on('blur', function () {
          calculateRow($(this).parent());
        });
        $('.itemRow .rateInput').unbind().on('blur', function () {
          calculateRow($(this).parent(), true);
        });
      }

      function calculateRow(row, updateRate) {
        var ddlItem = row.find('.ddlItem');
        var selectedRate = parseInt(ddlItem.parent().find(":selected").attr('rate'));
        var selectedDescription = ddlItem.parent().find(":selected").attr('description');

        var rateInput = ddlItem.parent().parent().find('.rateInput');
        var description = row.find('.inputDescription');
        var amountInput = ddlItem.parent().parent().find('.amountInput');
        var quantityInput = ddlItem.parent().parent().find('.quantityInput');
        var rate = parseInt(rateInput.text());
        var quantity = parseInt(quantityInput.text());

        if (!updateRate) {
          rate = selectedRate;
        }
        if (isNaN(quantity)) {
          quantityInput.text("1");
          quantity = 1;
        }
        if (!isNaN(rate) && rate !== undefined && quantity > 0) {
          rateInput.text(rate);
          amountInput.text(rate * quantity);
          calculateTotalAmount();
        }
        else {
          rateInput.text(0);
          amountInput.text(0);
          calculateTotalAmount();
        }
        description.html(selectedDescription);
      }

      function getUrlParameter(paramName) {
        var searchParams = new URLSearchParams(window.location.search);
        return searchParams.get(paramName);
      }

      calculateTotalAmount();
      function calculateTotalAmount() {
        var amount = 0;
        var discountOption = inputDiscountOption.val();
        var discount = isNaN(inputDiscount.val()) ? 0 : inputDiscount.val();

        var totalAmount = 0;
        $(".amountInput").each(function () {
          amount += parseInt($(this).text());;
        });
        if (isNaN(amount)) {
          amount = 0;
        }
        if (discount == "0" || isNaN(discount) || discount == "") {
          discount = 0;
        }

        var formattedAmount = parseFloat(amount).toFixed(2);
        formattedAmount = formattedAmount.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        inputSubtotal.val(formattedAmount);

        totalAmount = amount;
        if (discountOption === "1" && discount > 0) {
          totalAmount = totalAmount - (totalAmount * discount) / 100;
        }
        else if (discountOption === "2") {
          totalAmount = totalAmount - discount
        }

        var formattedTotalAmount = parseFloat(totalAmount).toFixed(2);
        var formattedDiscount = parseFloat(discount).toFixed(2);

        formattedTotalAmount = formattedTotalAmount.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        formattedDiscount = formattedDiscount.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        inputTotalAmount.val(formattedTotalAmount);
        inputDiscount.val(formattedDiscount);
      }

      function imageToBase64(url) {
        return fetch(url)
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to load image');
            }
            return response.blob();
          })
          .then(blob => {
            return new Promise((resolve, reject) => {
              let reader = new FileReader();
              reader.onloadend = function () {
                resolve(reader.result);
              };
              reader.onerror = function () {
                reject(new Error('Failed to read blob as data URL'));
              };
              reader.readAsDataURL(blob);
            });
          });
      }

      function formatAddress(billingBuilding, billingUnit, billingAddr1, billingAddr2, billingPostalCode, billingCity,
        billingState) {
        var formattedAddress = '';
        if (billingBuilding) {
          formattedAddress += billingBuilding + '<br>';
        }
        if (billingUnit) {
          formattedAddress += billingUnit;
        }
        if (billingAddr1) {
          formattedAddress += (billingUnit ? ', ' : '') + billingAddr1 + ', ';
        }
        if (billingAddr2) {
          formattedAddress += billingAddr2 + ', ';
        }
        if (billingPostalCode || billingCity || billingState) {
          formattedAddress += (billingPostalCode ? billingPostalCode + ' ' : '') +
            (billingCity ? billingCity + ', ' : '') +
            (billingState ? billingState : '');
        }
        $("#billingAddress").html(formattedAddress);
      }
    })
  </script>
  <script>
    $(document).ready(function () {
      const nowDate = moment().format('YYYY-MM-DD');
      $('#signedDate').val(nowDate);

      var confirmationModal = $("#confirmation-modal");
      var confirmationMessage = $("#confirmation-message");
      var btnConfirmModal = $("#btnConfirmModal");
      var btnSendEmail = $('#btnSendEmail');
      var btnSubmit = $('#btnSubmit');
      var loader = $("#loader");
      var signaturePad;
      var btnClearSignature = $("#btnClearSignature");
      var signaturePadContainer = $("#signature-pad");
      var btnStartSignature = $("#btnStartSigning");
      var btnComputerSignature = $("#btnComputerSignature");
      var computerSignLabel = $("#computerSignLabel");
      var btnDownloadPdf = $("#btnDownloadPdf");
      var inputSubtotal = $("#inputSubtotal");
      var inputDiscount = $("#inputDiscount");
      var inputDiscountOption = $("#inputDiscountOption");
      var inputTotalAmount = $("#inputTotalAmount");
      var docNumber = $("#docNumber");
      var recordId = $("#recordId");
      var discountOptionContainer = $("#discountOptionContainer");
      var picName = $("#picName").text();
      var picEmail = $("#picEmail").text();
      var companyEmail = $("#companyEmail").text();

      btnSubmit.click(function () {
        if ((typeof signaturePad !== 'undefined' && signaturePad.isEmpty()) && computerSignLabel.is(':hidden')) {
          confirmationMessage.text("Please provide a signature before submitting.");
          confirmationModal.modal('toggle');
          return;
        }
        else {
          confirmationMessage.text("Are you sure to submit this quotation?");
          confirmationModal.modal('toggle');
          return;
        }
      });

      btnSendEmail.click(async function () {
        var modifiedHTML = await flattenDocumentForSignature();
        generateSigningLink(modifiedHTML);
      });

      btnConfirmModal.click(async function () {
        if ((typeof signaturePad !== 'undefined' && signaturePad.isEmpty()) && computerSignLabel.is(':hidden')) {
          confirmationModal.modal('toggle');
          return;
        }
        else {
          confirmationModal.modal('toggle');
          var modifiedHTML = await flattenDocumentForSubmission();
          submitQuotation(modifiedHTML);
        }
      });

      btnStartSignature.click(function () {
        computerSignLabel.hide();
        signaturePadContainer.show();
        initSigningPad();
        signaturePadContainer.show();

      });

      btnClearSignature.click(function () {
        signaturePad.clear();
      });

      btnComputerSignature.click(function () {
        signaturePad.clear();
        computerSignLabel.show();
        signaturePadContainer.hide();
      });

      btnDownloadPdf.click(async function () {
        flattenDocument();
        btnDownloadPdf.hide();
        $("canvas").remove();
        var clonedDoc = document.cloneNode(true);
        var modifiedHTML = clonedDoc.documentElement.outerHTML;
        convertToPDF(modifiedHTML);
      });

      function submitQuotation(modifiedHTML) {
        var services = [];
        var totalDiscountAmount = 0;
        var discountPercentage = 0;
        var discountValue = 0;
        var subTotal = parseFloat(inputSubtotal.val().replace(/,/g, ''));
        var totalAmount = parseFloat(inputTotalAmount.val().replace(/,/g, ''));
        if (discountOptionContainer.is(':visible')) {
          if ($(".discountOption").text() === "DISCOUNT PERCENT") {
            discountPercentage = parseFloat($("#inputDiscount").val().replace(/,/g, ''));
          }
          else {
            discountValue = parseFloat($("#inputDiscount").val().replace(/,/g, ''));
          }
        }
        totalDiscountAmount = discountValue + ((subTotal * discountPercentage) / 100);


        $(".itemRow").each(function () {
          services.push({
            item: $(this).find(".itemInput").attr('itemSKU'),
            itemName: $(this).find('.itemInput').text(),
            quantity: parseFloat($(this).find(".quantityInput").text().replace(/,/g, '')),
            rate: parseFloat($(this).find('.rateInput').text().replace(/,/g, '')),
            amount: parseFloat($(this).find('.amountInput').text().replace(/,/g, '')),
          })
        });
        var url = 'https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjUwNTY1MDYzZjA0MzA1MjZiNTUzYzUxMzUi_pc';

        loader.show();
        var requestBody = {
          services: services,
          subtotal: subTotal,
          discountValue: discountValue,
          discountPercentage: discountPercentage,
          totalDiscountAmount: totalDiscountAmount,
          taxPercentage: 0,
          totalTaxAmount: 0,
          totalAmount: totalAmount,
          docNumber: docNumber.text(),
          recordId: recordId.val(),
          htmlContent: modifiedHTML,
          picName: picName,
          picEmail: picEmail,
          companyEmail: companyEmail
        };
        $.ajax({
          url: url,
          type: 'POST',
          data: JSON.stringify(requestBody),
          contentType: 'multipart/form-data',
          success: function (response) {
            console.log('Success:', response);
          },
          error: function (xhr, status, error) {
            console.error('Error:', error);
          }
        });

        setTimeout(() => {
          $(".circle").hide();
          $(".message-text").text("Quotation Submitted Successfully");
          $("#success-card").show();
        }, 2000);
        var newTab = window.open();
        newTab.document.open();
        newTab.document.write(modifiedHTML);
        newTab.document.close();
      }

      function flattenDocument() {
        $('input, select, textarea').prop('readonly', true);
        $('[contenteditable]').attr('contenteditable', 'false');
        $('.actionRow').remove();

        var selectedServices = [];
        $(".ddlItem").each(function () {
          selectedServices.push(
            {
              itemSKU: $(this).val(),
              itemName: $(this).find('option:selected').text()
            });
        });
        var index = 0;
        $('.ddlItem').each(function () {
          $(this).replaceWith(`<span class='itemInput font-xxs' itemSKU='${selectedServices[index].itemSKU}'>${selectedServices[index].itemName}</span>`);
          index = index + 1;
        });

        var discountOption = $("#inputDiscountOption").val();
        if (discountOption === "0") {
          discountOptionContainer.remove();
        }
        else if (discountOption === "1" || discountOption === "2") {
          var discountOptionText = $("#inputDiscountOption").find('option:selected').text();
          $("#inputDiscountOption").each(function () {
            $(this).replaceWith(`<label class="discountOption font-xxs font-bold col-7 text-end">${discountOptionText}</label>`);
          })
        }
        $("input").each(function () {
          $(this).attr("value", $(this).val());
        });
        $('#init-script').remove();

      }

      async function flattenDocumentForSignature() {
        flattenDocument();
        var removeSignature = false;
        $('#btnSendEmail').remove();
        $('#btnSubmit').show();
        if (computerSignLabel.is(':visible')) {
          $('#btnClearSignature').hide();
          $('#btnStartSigning').hide();
          $('#btnComputerSignature').hide();
        }
        else if ((typeof signaturePad !== 'undefined' && !signaturePad.isEmpty()) && computerSignLabel.is(':hidden')) {
          signaturePadContainer.show();
          var originalCanvas = document.querySelector("#signature-pad canvas");
          var signatureImage = originalCanvas.toDataURL("image/png");
          $("#signature-pad").append(`<img src="${signatureImage}" class="signature-image" alt="Signature">`);
          $(".signature-pad--body").first().hide();
          $("#signature-pad").removeAttr('id');
          removeSignature = true;
          $("canvas").remove();
          $('#btnClearSignature').hide();
          $('#btnStartSigning').hide();
          $('#btnComputerSignature').hide();
        }
        else {
          $('#btnClearSignature').show();
          $('#btnStartSigning').show();
          $('#btnComputerSignature').hide();
        }

        var styleElement = document.createElement('style');
        var clonedDoc = document.cloneNode(true);
        $(clonedDoc).find('head').append(styleElement);
        var modifiedHTML = clonedDoc.documentElement.outerHTML;
        if (removeSignature)
          modifiedHTML = modifiedHTML.replace(/initSigningPad\(\);/g, '');
        return modifiedHTML;
      }

      async function flattenDocumentForSubmission() {
        flattenDocument();
        var selectedServices = [];
        $(".itemInput").each(function () {
          selectedServices.push(
            {
              itemSKU: $(this).val(),
              itemName: $(this).find('option:selected').text()
            });
        });
        var index = 0;

        btnSendEmail.remove();
        btnSubmit.remove();
        btnClearSignature.remove();
        btnStartSignature.remove();
        btnComputerSignature.remove();
        btnDownloadPdf.show();

        if (computerSignLabel.is(':visible')) {
          signaturePadContainer.hide();
        }
        else {
          signaturePadContainer.show();
          var originalCanvas = document.querySelector("#signature-pad canvas");
          var signatureImage = originalCanvas.toDataURL("image/png");
          $("#signatureCell").html(`<img src="${signatureImage}" class="signature-image" alt="Signature">`);
          $("#signature-pad").append(`<img src="${signatureImage}" class="signature-image" alt="Signature">`);
          $("#signature-pad").removeAttr('id');
          $("canvas").remove();
        }

        $('#init-script').remove();
        $("#confirmation-modal").remove();
        $(".modal-backdrop").remove();
        $("body").removeClass("modal-open");
        $("body").css("overflow", "scroll");
        $("body").css("overflow", "scroll");
        $(".signature-pad--body").css("display", "none");
        var styleElement = document.createElement('style');
        var clonedDoc = document.cloneNode(true);
        $(clonedDoc).find('head').append(styleElement);
        var modifiedHTML = clonedDoc.documentElement.outerHTML;
        modifiedHTML = modifiedHTML.replace(/initSigningPad\(\);/g, '');
        return modifiedHTML;
      }

      async function convertToPDF(htmlContent) {
        var docNumber = $("#docNumber").text();
        var docName = `Quotation ${docNumber}`;
        const options = {
          filename: 'document.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().from(htmlContent).set(options).toPdf().output('blob').then(function (pdfBlob) {
          var link = document.createElement('a');
          link.href = URL.createObjectURL(pdfBlob);
          console.log(link.href);
          link.download = 'document.pdf';
          link.click();
        }).catch(error => {
          console.error("Error generating PDF:", error);
          btnDownloadPdf.show();
        });
      }

      function generateSigningLink(htmlContent) {
        loader.show();
        var apiUrl = 'https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjUwNTY1MDYzZjA0M2Q1MjZjNTUzMzUxM2Ei_pc';
        var picName = $("#picName").text();
        var picEmail = $("#picEmail").text();
        var companyEmail = $("#companyEmail").text();
        var recordId = $("#recordId").val();
        var docNumber = $("#docNumber").text();

        $.ajax({
          url: apiUrl,
          type: 'POST',
          data: JSON.stringify({
            html: htmlContent,
            picEmail: picEmail,
            picName: picName,
            companyEmail: companyEmail,
            recordId: recordId,
            docNumber: docNumber
          }),
          contentType: 'multipart/form-data',
          success: function (response) {
            console.log('HTML content sent successfully:', response);
          },
          error: function (xhr, status, error) {
            console.error('Error sending HTML content:', error);
          }
        });

        setTimeout(() => {
          $(".circle").hide();
          $(".message-text").text("Quotation Sent Successfully");
          $("#success-card").show();
        }, 2000);

        var newTab = window.open();
        newTab.document.open();
        newTab.document.write(htmlContent);
        newTab.document.close();
      }

      initSigningPad();
      function initSigningPad() {
        var wrapper = document.getElementById("signature-pad");
        var canvas = wrapper.querySelector("canvas");
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad = new SignaturePad(canvas, {
          backgroundColor: 'rgb(255, 255, 255)'
        });
        $("#signature-pad").hide();
      }
    });
  </script>
</body>

</html>